<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>å¥åº·æ‰“å¡ï½œæ•ˆç‡ä¼˜å…ˆ</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
      --card:#fafafa; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      color:var(--fg);
      background:linear-gradient(180deg,#fff,#fbfbfb);
    }
    .wrap{max-width:860px; margin:0 auto; padding:20px 16px 40px}
    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      padding:10px 2px 6px;
    }
    h1{font-size:22px; margin:0}
    .sub{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--line); border-radius:999px; background:#fff;
      font-size:12px;
    }
    .grid{display:grid; grid-template-columns:1.1fr 0.9fr; gap:12px; margin-top:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 1px 0 rgba(17,24,39,.03);
    }
    .card h2{margin:0 0 10px; font-size:16px}

    .row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 8px;
      border-radius:14px;
    }
    .row + .row{margin-top:6px}

    .meta{font-size:12px; color:var(--muted)}

    button{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      cursor:pointer;
    }
    button.primary{background:#111827; color:#fff; border-color:#111827}

    .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    .food-scroll{
      display:flex;
      gap:12px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      padding-bottom:6px;
    }

    .food-item{
      min-width:260px;
      scroll-snap-align:start;
      flex-direction:column;
      align-items:flex-start;
      justify-content:space-between;
      border:1px solid var(--line);
      background:#fff;
    }
  </style>
</head>

<body>
<div class="wrap">

<header>
  <div>
    <h1>å¥åº·æ‰“å¡ï½œæ•ˆç‡ä¼˜å…ˆ</h1>
    <div class="sub">ç›®æ ‡ï¼šç¨³èƒ½é‡ã€å°‘æ³¢åŠ¨ã€é•¿æœŸå¯æ‰§è¡Œ</div>
  </div>
  <div class="pill"><span id="todayLabel">â€”</span></div>
</header>

<div class="grid">

<section class="card">
  <h2>ä»Šæ—¥æ‰§è¡Œæ¸…å•</h2>

  <div class="row"><input type="checkbox"/> åƒäº†æ—©é¤ï¼ˆå«è›‹ç™½ï¼‰</div>
  <div class="row"><input type="checkbox"/> åˆé¤æœ‰ä¸»é£Ÿ + è›‹ç™½</div>
  <div class="row"><input type="checkbox"/> å’–å•¡ â‰¤ 1 æ¯ï¼ˆä¸ç©ºè…¹ï¼‰</div>
  <div class="row"><input type="checkbox"/> é¥®æ°´ â‰¥ 2 L</div>
  <div class="row"><input type="checkbox"/> 00:30 å‰èººä¸‹</div>

  <div class="btns">
    <button class="primary">ä¿å­˜ä»Šæ—¥</button>
  </div>
</section>

<aside class="card">
  <h2>ğŸ½ï¸ ä¸çŸ¥é“åƒä»€ä¹ˆï¼Ÿï¼ˆå·¦å³æ»‘ï¼‰</h2>

  <div class="food-scroll">

    <div class="row food-item">
      <strong>ä»Šå¤©å¾ˆç´¯</strong>
      <div>åŸç‰‡ç‡•éº¦ / çº¢è–¯ + é¸¡è›‹</div>
      <div class="meta">ç¨³èƒ½é‡ï¼Œä¸çŠ¯å›°</div>
    </div>

    <div class="row food-item">
      <strong>æ’‘ä¸€ä¸‹åˆ</strong>
      <div>æ‚ç²®é¥­ + è›‹ç™½ + è”¬èœ</div>
      <div class="meta">ä¸‹åˆæ›´å¹³ç¨³</div>
    </div>

    <div class="row food-item">
      <strong>ç¡æ™šä¿®å¤</strong>
      <div>çº¢è–¯ + è›‹ç™½ + æ¸©çƒ­èœ</div>
      <div class="meta">å¯¹ç³»ç»Ÿæ¸©å’Œ</div>
    </div>

    <div class="row food-item">
      <strong>æƒ³åƒé¢</strong>
      <div>èéº¦é¢ï¼ˆåŠä»½ï¼‰+ è›‹ç™½</div>
      <div class="meta">è§£é¦‹ä½†ä¸æ”¾å¤§æ³¢åŠ¨</div>
    </div>

    <div class="row food-item">
      <strong>èƒƒå£å·®</strong>
      <div>æ¸…æ±¤ + è›‹èŠ± / è±†è…</div>
      <div class="meta">é¿å…èƒ½é‡å¡Œé™·</div>
    </div>

    <div class="row food-item">
      <strong>å¤–é£Ÿå…œåº•</strong>
      <div>æœ‰ä¸»é£Ÿ + æœ‰è›‹ç™½ + å°‘æ±¤</div>
      <div class="meta">çœ‹èµ·æ¥ç¨³æœ€é‡è¦</div>
    </div>

  </div>
</aside>

</div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const tzOffsetMin = new Date().getTimezoneOffset();

  function yyyy_mm_dd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function parseDate(s){
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d);
  }
  function addDays(date, n){
    const d = new Date(date); d.setDate(d.getDate()+n); return d;
  }

  const STORAGE_KEY = "health_checkin_v1";
  function loadAll(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch(e){ return {}; }
  }
  function saveAll(obj){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }

  let cursor = new Date();
  let data = loadAll();

  function getDay(key){
    return data[key] || {checks:[false,false,false,false,false], meta:{}, savedAt:null};
  }

  function computeScore(day){
    return (day.checks || []).filter(Boolean).length;
  }

  function statusTag(score){
    if(score >= 5) return {txt:"æ»¡åˆ†", cls:"ok"};
    if(score >= 3) return {txt:"åˆæ ¼", cls:"warn"};
    if(score >= 1) return {txt:"èµ·æ­¥", cls:"warn"};
    return {txt:"æœªæ‰“å¡", cls:"bad"};
  }

  function setTag(el, tag){
    el.className = "tag " + tag.cls;
    el.textContent = tag.txt;
  }

  function calcStreak(all, todayKey){
    // streak: consecutive days ending at today with score>0
    let d = parseDate(todayKey);
    let streak = 0;
    while(true){
      const k = yyyy_mm_dd(d);
      const day = all[k];
      if(!day) break;
      if(computeScore(day) <= 0) break;
      streak += 1;
      d = addDays(d, -1);
    }
    return streak;
  }

  function weekStats(all, endKey){
    // last 7 days including endKey
    let d = parseDate(endKey);
    let total = 0;
    let bars = [];
    for(let i=0;i<7;i++){
      const k = yyyy_mm_dd(addDays(d, -6+i));
      const sc = all[k] ? computeScore(all[k]) : 0;
      total += sc;
      bars.push(sc);
    }
    return {total, bars};
  }

  function renderSpark(bars){
    const el = $("spark");
    el.innerHTML = "";
    for(let i=0;i<bars.length;i++){
      const b = document.createElement("div");
      b.className = "bar" + (bars[i] > 0 ? " on":"");
      b.style.height = (10 + bars[i]*6) + "px";
      b.title = `Day ${i+1}: ${bars[i]}/5`;
      el.appendChild(b);
    }
  }

  function setUIForKey(key){
    const day = getDay(key);
    $("todayLabel").textContent = key;

    const checks = day.checks || [false,false,false,false,false];
    ["c1","c2","c3","c4","c5"].forEach((id, idx) => { $(id).checked = !!checks[idx]; });

    const meta = day.meta || {};
    $("carbType").value = meta.carbType || "";
    $("postMeal").value = meta.postMeal || "";
    $("seaweed").value = meta.seaweed || "";
    $("water").value = meta.water ?? "";
    $("bedtime").value = meta.bedtime || "";
    $("coffee").value = meta.coffee ?? "";
    $("note").value = meta.note || "";

    const score = computeScore(day);
    $("score").textContent = `${score}/5`;
    setTag($("statusTag"), statusTag(score));

    const st = calcStreak(data, yyyy_mm_dd(new Date()));
    $("streak").textContent = `Streak: ${st}`;

    const wk = weekStats(data, key);
    $("weekScore").textContent = `${wk.total}/35`;
    renderSpark(wk.bars);
  }

  function collectDayFromUI(){
    return {
      checks: [
        $("c1").checked, $("c2").checked, $("c3").checked, $("c4").checked, $("c5").checked
      ],
      meta: {
        carbType: $("carbType").value,
        postMeal: $("postMeal").value,
        seaweed: $("seaweed").value,
        water: $("water").value ? Number($("water").value) : null,
        bedtime: $("bedtime").value,
        coffee: $("coffee").value ? Number($("coffee").value) : null,
        note: $("note").value
      },
      savedAt: new Date().toISOString()
    };
  }

  function saveCurrent(){
    const key = yyyy_mm_dd(cursor);
    data[key] = collectDayFromUI();
    saveAll(data);
    setUIForKey(key);
    toast("å·²ä¿å­˜ âœ…");
  }

  function toast(msg){
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.position="fixed";
    t.style.left="50%";
    t.style.bottom="24px";
    t.style.transform="translateX(-50%)";
    t.style.padding="10px 12px";
    t.style.border="1px solid var(--line)";
    t.style.borderRadius="14px";
    t.style.background="#fff";
    t.style.boxShadow="0 6px 18px rgba(0,0,0,.08)";
    t.style.zIndex=9999;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 1400);
  }

  // Navigation
  $("saveBtn").addEventListener("click", saveCurrent);
  $("prevBtn").addEventListener("click", () => { cursor = addDays(cursor, -1); setUIForKey(yyyy_mm_dd(cursor)); });
  $("nextBtn").addEventListener("click", () => { cursor = addDays(cursor,  1); setUIForKey(yyyy_mm_dd(cursor)); });
  $("todayBtn").addEventListener("click", () => { cursor = new Date(); setUIForKey(yyyy_mm_dd(cursor)); });

  // Export
  $("exportBtn").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "health-checkin-data.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Import
  $("importBtn").addEventListener("click", () => $("fileInput").click());
  $("fileInput").addEventListener("change", async (e) => {
    const f = e.target.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(typeof obj !== "object" || Array.isArray(obj)) throw new Error("æ ¼å¼ä¸å¯¹");
      data = obj;
      saveAll(data);
      setUIForKey(yyyy_mm_dd(cursor));
      toast("å·²å¯¼å…¥ âœ…");
    }catch(err){
      alert("å¯¼å…¥å¤±è´¥ï¼š" + err.message);
    }finally{
      e.target.value = "";
    }
  });

  // Reset
  $("resetBtn").addEventListener("click", () => {
    if(confirm("ç¡®å®šæ¸…ç©ºæœ¬æœºæ‰€æœ‰æ‰“å¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")){
      data = {};
      saveAll(data);
      setUIForKey(yyyy_mm_dd(cursor));
      toast("å·²æ¸…ç©º");
    }
  });

  // PWA install
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js?v=2").catch(()=>{});
  }

  // Init
  setUIForKey(yyyy_mm_dd(cursor));
})();
</script>

</body>
</html>
